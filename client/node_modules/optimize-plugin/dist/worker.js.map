{"version":3,"file":"worker.js","sources":["../src/lib/transform-change-webpack-urls.js","../src/lib/transform-extract-polyfills.js","../src/lib/util.js","../src/worker.js"],"sourcesContent":["/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Detects and analyzes a Webpack \"entry\" bundle, allowing String transformations on its internal chunk URL map.\n *\n * @example\n * {\n *   plugins: [\n *     ['./transform-change-webpack-urls', {\n *       pattern: /\\.js$/,\n *       replacement: '.legacy.js'\n *     }]\n *   ]\n * }\n *\n * @see https://astexplorer.net/#/gist/0995f8452cfa62d797a2a778a3442b65/2e588cc89829971495ca8e38905bb5581a23cf5d\n */\n\n/** @typedef NodePath @type {import('@babel/core').NodePath} */\n\nexport default function ({ types: t }) {\n  function unwrap (path) {\n    if (t.isExpressionStatement(path)) {\n      return unwrap(path.get('expression'));\n    }\n    if (t.isUnaryExpression(path) && path.node.operator === '!') {\n      return unwrap(path.get('argument'));\n    }\n    return path;\n  }\n\n  /**\n   * Attempt to parse a path and find a webpack Bootstrap function, if so returning a description.\n   * @param {NodePath} path\n   */\n  function getWebpackBootstrap (path) {\n    path = unwrap(path);\n    if (!t.isCallExpression(path)) return false;\n    const factory = path.get('callee');\n    if (!t.isFunctionExpression(factory)) return false;\n    const bootstrap = parseWebpackBootstrap(factory);\n    if (!bootstrap || !bootstrap.confident) return false;\n    const args = path.get('arguments');\n    bootstrap.modules = getWebpackModules(args);\n    return bootstrap;\n  }\n\n  /**\n   * Verify that a Path is a \"bootstrap\" function, which is Webpack's module registry and loader implementation.\n   * @param {NodePath} path\n   */\n  function parseWebpackBootstrap (path) {\n    const bootstrap = {\n      confident: false,\n      /** @type {NodePath} */\n      factory: null,\n      /** @type {NodePath} */\n      urlMap: null\n    };\n\n    // // TODO: this is silly and should use binding lookup + parent checks. Something like:\n    // const bindings = path.get('body').scope.bindings;\n    // console.log(path.get('body').scope.hasGlobal('window'));\n    // for (let name in bindings) {\n    //   const binding = bindings[name];\n    //   if (1){}\n    // }\n    // bindings.some(b => {\n    //   b.referencePaths.some(p => t.isMemberExpression(p.parent) && t.isAssignmentExpression(p.parentPath.parent) && p.parent.property.name === 'oe')\n    // });\n\n    const identifiers = {};\n    path.get('body').traverse({\n      MemberExpression (p) {\n        // Find the script loader function (indicated by the presence of document.createElement(\"script\").\n        // Note that this check *does* traverse into nested functions.\n        if (t.matchesPattern(p.node, 'document.createElement') && t.isCallExpression(p.parent) && t.isStringLiteral(p.parent.arguments[0], { value: 'script' })) {\n          const id = p.parentPath.parent.id.name;\n          p.scope.getBinding(id).referencePaths.forEach(p => {\n            // Find script.src= assignment mapping:\n            const parent = p.parentPath;\n            if (t.isMemberExpression(parent) && t.isIdentifier(parent.node.property, { name: 'src' }) && t.isAssignmentExpression(parent.parent)) {\n              // Find the assigned value: s.src = X\n              let expr = parent.parentPath.get('right').resolve();\n              // It might be a function call:\n              if (t.isCallExpression(expr)) {\n                expr = expr.get('callee').resolve();\n              }\n              // That function call might be an IIFE (it generally is):\n              if (t.isFunction(expr)) {\n                expr = expr.get('body.body').filter(t.isReturnStatement)[0];\n                if (expr) expr = expr.get('argument');\n              }\n              // Store it for later manipulation\n              bootstrap.urlMap = expr;\n            }\n          });\n          return;\n        }\n\n        // Detect extensions to Webpack's main namespace.\n        // They're assignments to properties on a local binding, but we don't yet know which one.\n        // We ignore nested functions, and only look at assignments.\n        if (p.scope !== path.scope || !t.isAssignmentExpression(p.parent)) {\n          return;\n        }\n        if (t.isIdentifier(p.node.object) && t.isIdentifier(p.node.property)) {\n          let a = identifiers[p.node.object.name];\n          if (!a) a = identifiers[p.node.object.name] = {};\n          a[p.node.property.name] = p;\n        }\n      }\n    });\n    // shallowWalk(path.get('body'), p => {\n    //  if (!t.isMemberExpression(p)) return;\n    //  if (t.isIdentifier(p.node.object) && t.isIdentifier(p.node.property)) {\n    //    let a = identifiers[p.node.object.name];\n    //    if (!a) a = identifiers[p.node.object.name] = {};\n    //    a[p.node.property.name] = true;\n    //  }\n    // });\n\n    // Check if we found a binding with properties that signify a Webpack namespace object:\n    for (const a in identifiers) {\n      const v = identifiers[a];\n      // Look for `__webpack_public_path__`, `__webpack_modules__` and an onerror handler:\n      if (v.p && v.c && v.oe) {\n        bootstrap.confident = true;\n        bootstrap.factory = path;\n        // might be useful later\n        bootstrap.api = v;\n        break;\n      }\n    }\n\n    // Regardless of structure, a `window.webpackJsonp` reference means this is a webpack bootstrap function:\n    if (identifiers.window && identifiers.window.webpackJsonp) {\n      bootstrap.confident = true;\n      bootstrap.factory = path;\n      bootstrap.webpackJsonp = identifiers.window.webpackJsonp;\n    }\n\n    return bootstrap;\n  }\n\n  function getWebpackModules (list) {\n    const modules = [];\n    const mod = m => {\n      if (t.isFunctionExpression(m)) {\n        modules.push(m);\n      } else {\n        throw Error('Not a webpack bundle');\n      }\n    };\n    list.forEach(m => {\n      if (t.isArrayExpression(m)) {\n        m.get('elements').forEach(mod);\n      } else {\n        mod(m);\n      }\n    });\n    return modules;\n  }\n\n  // function shallowWalk(path, callback) {\n  //   if (Array.isArray(path)) {\n  //     for (let i=0; i<path.length; i++) shallowWalk(path[i], callback);\n  //   }\n  //   else if (t.isVariableDeclaration(path)) {\n  //     shallowWalk(path.get('declarations'), callback);\n  //   }\n  //   else if (t.isVariableDeclarator(path)) {\n  //     shallowWalk(path.get('id'), callback);\n  //     shallowWalk(path.get('init'), callback);\n  //   }\n  //   else if (t.isBlockStatement(path)) {\n  //     shallowWalk(path.get('body'), callback);\n  //   }\n  //   else if (t.isExpressionStatement(path)) {\n  //     shallowWalk(path.get('expression'), callback);\n  //   }\n  //   else if (t.isAssignmentExpression(path)) {\n  //     shallowWalk(path.get('left'), callback);\n  //     shallowWalk(path.get('right'), callback);\n  //   }\n  //   else if (t.isSequenceExpression(path)) {\n  //     shallowWalk(path.get('expressions'), callback);\n  //   }\n  //   else if (t.isUnaryExpression(path)) {\n  //     shallowWalk(path.get('argument'), callback);\n  //   }\n  //   else if (!t.isFunction(path)) {\n  //     callback(path);\n  //   }\n  // }\n\n  return {\n    name: 'transform-change-webpack-urls',\n    visitor: {\n      Program (path, state) {\n        const opts = state.opts || {};\n        const pattern = opts.pattern || /\\.js$/;\n        const replacement = opts.replacement || '.modern.js';\n\n        path.get('body').forEach(expr => {\n          const bootstrap = getWebpackBootstrap(expr);\n          if (!bootstrap) return;\n\n          // Replace the template part containing \".js\" with \".module.js\"\n          if (bootstrap.urlMap) {\n            bootstrap.urlMap.traverse({\n              StringLiteral (s) {\n                if (/\\.js$/.test(s.node.value)) {\n                  s.replaceWith(t.stringLiteral(s.node.value.replace(pattern, replacement)));\n                  s.stop();\n                }\n              }\n            });\n          }\n        });\n      }\n    }\n  };\n}\n","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport default function () {\n  return {\n    name: 'transform-extract-polyfills',\n    visitor: {\n      ImportDeclaration (path, state) {\n        state.opts.onPolyfill(path.node.source.value);\n        path.remove();\n      }\n    }\n  };\n}\n","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Convert a Babel-style SourceMap to Terser-style, parsing if necessary.\n * @param {(import('@babel/core').BabelFileResult)['map']|string|null} map\n * @return {import('source-map').RawSourceMap|null} map\n * @todo This should be deleted, as it's exclusively to make TypeScript happy.\n */\nexport function toTerserMap (map) {\n  if (typeof map === 'string') map = JSON.parse(map);\n  return typeof map === 'object' && map ? {\n    ...map,\n    version: String(map.version)\n  } : null;\n}\n\n/**\n * Convert a Terser-style SourceMap to Babel-style, parsing if necessary.\n * @param {import('source-map').RawSourceMap|string|null} map\n * @returns {(import('@babel/core').BabelFileResult)['map']|null}\n * @todo This should be deleted, as it's exclusively to make TypeScript happy.\n */\nexport function toBabelMap (map) {\n  if (typeof map === 'string') map = JSON.parse(map);\n  return typeof map === 'object' && map ? {\n    file: '',\n    ...map,\n    version: parseInt(map.version, 10)\n  } : null;\n}\n\nconst DEFAULT_COREJS_VERSION = 2;\n\nlet corejsVersion;\n\n/**\n * Get the user's installed version of core-js\n * @returns {number}\n */\nexport function getCorejsVersion () {\n  if (!corejsVersion) {\n    try {\n      // @ts-ignore\n      corejsVersion = parseInt(require('core-js/package.json').version, 10);\n      console.log(`[OptimizePlugin] Detected core-js version ${corejsVersion}`);\n    } catch (e) {\n      console.warn(\n        `[OptimizePlugin] Unable to detect installed version of core-js. Assuming core-js@${DEFAULT_COREJS_VERSION}.`\n      );\n      corejsVersion = DEFAULT_COREJS_VERSION;\n    }\n  }\n  return corejsVersion;\n}\n\nexport function createPerformanceTimings () {\n  const timings = [];\n\n  const start = name => {\n    timings.push({ name, start: Date.now() });\n  };\n\n  const end = name => {\n    for (const entry of timings) {\n      if (entry.name === name) {\n        entry.end = Date.now();\n        entry.duration = entry.end - entry.start;\n        return;\n      }\n    }\n  };\n\n  return {\n    timings,\n    start,\n    end\n  };\n}\n","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as terser from 'terser';\nimport babel from '@babel/core';\nimport transformWebpackUrls from './lib/transform-change-webpack-urls';\nimport extractPolyfills from './lib/transform-extract-polyfills';\nimport { toBabelMap, toTerserMap, createPerformanceTimings } from './lib/util';\n\nconst NAME = 'OptimizePlugin';\n\nconst TERSER_CACHE = {};\n\nconst noopTimings = { timings: [], start: n => {}, end: n => {} };\n\n/**\n * @param {object} $0\n * @param {string} $0.file\n * @param {string} $0.source\n * @param {string|object} $0.map\n * @param {object} [$0.options]\n * @param {boolean} [$0.options.timings = false]\n * @param {boolean} [$0.options.minify = false]\n * @param {boolean} [$0.options.downlevel = false]\n * @param {boolean} [$0.options.modernize = false]\n * @param {number} [$0.options.corejsVersion]\n */\nexport async function process ({ file, source, map, options = {} }) {\n  const { timings, start, end } = options.timings ? createPerformanceTimings() : noopTimings;\n  const { minify, downlevel, modernize } = options;\n\n  const polyfills = new Set();\n  let legacy;\n\n  const outputOptions = {\n    compact: minify,\n    minified: minify,\n    // envName: minify ? 'production' : 'development',\n    comments: minify ? false : undefined,\n    generatorOpts: {\n      concise: true\n    }\n  };\n\n  start('modern');\n  const modern = await babel.transformAsync(source, {\n    configFile: false,\n    babelrc: false,\n    filename: file,\n    inputSourceMap: map,\n    sourceMaps: true,\n    sourceFileName: file,\n    sourceType: 'module',\n    envName: 'modern',\n    // ast: true,\n    presets: [\n      ['@babel/preset-env', {\n        loose: true,\n        modules: false,\n        bugfixes: true,\n        targets: {\n          esmodules: true\n        },\n        // corejs: options.corejsVersion,\n        useBuiltIns: false\n      }],\n      modernize && ['babel-preset-modernize', {\n        loose: true,\n        webpack: true\n      }]\n    ].filter(Boolean),\n    ...outputOptions,\n    caller: {\n      supportsStaticESM: true,\n      name: NAME + '-modern'\n    }\n  });\n  end('modern');\n\n  if (minify) {\n    start('modern-minify');\n    const minified = terser.minify(modern.code, {\n      // Enables shorthand properties in objects and object patterns:\n      ecma: 2017,\n      module: false,\n      nameCache: TERSER_CACHE,\n      // sourceMap: true,\n      sourceMap: {\n        content: toTerserMap(modern.map)\n      },\n      compress: {\n        global_defs: {\n          MODERN_MODE: true,\n          'process.env.NODE_ENV': global.process.env.NODE_ENV || 'production'\n        }\n      },\n      // Fix Safari 10 issues\n      // ({a}) --> ({a:a})\n      // !await a --> !(await a)\n      safari10: true,\n      mangle: {\n        // safari10: true\n        // properties: {\n        //   regex: /./\n        // }\n      }\n    });\n\n    modern.code = minified.code;\n    modern.map = toBabelMap(minified.map);\n\n    // @todo this means modern.ast is now out-of-sync with modern.code\n    // can this work? or do we need to run Terser separately for modern/legacy?\n    end('modern-minify');\n  }\n\n  if (downlevel) {\n    start('legacy');\n    // legacy = await babel.transformFromAstAsync(modern.ast, modern.code, {\n    legacy = await babel.transformAsync(modern.code, {\n      configFile: false,\n      babelrc: false,\n      filename: file,\n      inputSourceMap: modern.map,\n      sourceMaps: true,\n      sourceFileName: file,\n      sourceType: 'module',\n      envName: 'legacy',\n      presets: [\n        ['@babel/preset-env', {\n          loose: true,\n          modules: false,\n          // corejs: 3,\n          corejs: options.corejsVersion,\n          useBuiltIns: 'usage'\n        }]\n      ],\n      plugins: [\n        [transformWebpackUrls, {\n          pattern: /\\.js$/,\n          replacement: '.legacy.js'\n        }],\n        [extractPolyfills, {\n          onPolyfill (specifier) {\n            polyfills.add(specifier);\n          }\n        }]\n      ],\n      ...outputOptions,\n      caller: {\n        supportsStaticESM: false,\n        name: NAME + '-legacy'\n      }\n    });\n    end('legacy');\n  }\n\n  return {\n    modern: sanitizeResult(modern),\n    legacy: legacy && sanitizeResult(legacy),\n    polyfills: Array.from(polyfills),\n    timings\n  };\n}\n\nfunction sanitizeResult (result) {\n  return { source: result.code, map: result.map };\n}\n"],"names":["types","t","unwrap","path","isExpressionStatement","get","isUnaryExpression","node","operator","getWebpackBootstrap","isCallExpression","factory","isFunctionExpression","bootstrap","parseWebpackBootstrap","confident","args","modules","getWebpackModules","urlMap","identifiers","traverse","MemberExpression","p","matchesPattern","parent","isStringLiteral","arguments","value","id","parentPath","name","scope","getBinding","referencePaths","forEach","isMemberExpression","isIdentifier","property","isAssignmentExpression","expr","resolve","isFunction","filter","isReturnStatement","object","a","v","c","oe","api","window","webpackJsonp","list","mod","m","push","Error","isArrayExpression","visitor","Program","state","opts","pattern","replacement","StringLiteral","s","test","replaceWith","stringLiteral","replace","stop","ImportDeclaration","onPolyfill","source","remove","toTerserMap","map","JSON","parse","version","String","toBabelMap","file","parseInt","createPerformanceTimings","timings","start","Date","now","end","entry","duration","NAME","TERSER_CACHE","noopTimings","n","process","options","minify","downlevel","modernize","polyfills","Set","legacy","outputOptions","compact","minified","comments","undefined","generatorOpts","concise","modern","babel","transformAsync","configFile","babelrc","filename","inputSourceMap","sourceMaps","sourceFileName","sourceType","envName","presets","loose","bugfixes","targets","esmodules","useBuiltIns","webpack","Boolean","caller","supportsStaticESM","terser","code","ecma","module","nameCache","sourceMap","content","compress","global_defs","MODERN_MODE","global","env","NODE_ENV","safari10","mangle","corejs","corejsVersion","plugins","transformWebpackUrls","extractPolyfills","specifier","add","sanitizeResult","Array","from","result"],"mappings":"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"}