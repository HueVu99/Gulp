{"version":3,"file":"optimize-plugin.js","sources":["../src/lib/util.js","../src/lib/rollup-plugin-terser-simple.js","../src/lib/rollup-plugin-strip-comments.js","../src/lib/worker-pool.js","../src/index.js"],"sourcesContent":["/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Convert a Babel-style SourceMap to Terser-style, parsing if necessary.\n * @param {(import('@babel/core').BabelFileResult)['map']|string|null} map\n * @return {import('source-map').RawSourceMap|null} map\n * @todo This should be deleted, as it's exclusively to make TypeScript happy.\n */\nexport function toTerserMap (map) {\n  if (typeof map === 'string') map = JSON.parse(map);\n  return typeof map === 'object' && map ? {\n    ...map,\n    version: String(map.version)\n  } : null;\n}\n\n/**\n * Convert a Terser-style SourceMap to Babel-style, parsing if necessary.\n * @param {import('source-map').RawSourceMap|string|null} map\n * @returns {(import('@babel/core').BabelFileResult)['map']|null}\n * @todo This should be deleted, as it's exclusively to make TypeScript happy.\n */\nexport function toBabelMap (map) {\n  if (typeof map === 'string') map = JSON.parse(map);\n  return typeof map === 'object' && map ? {\n    file: '',\n    ...map,\n    version: parseInt(map.version, 10)\n  } : null;\n}\n\nconst DEFAULT_COREJS_VERSION = 2;\n\nlet corejsVersion;\n\n/**\n * Get the user's installed version of core-js\n * @returns {number}\n */\nexport function getCorejsVersion () {\n  if (!corejsVersion) {\n    try {\n      // @ts-ignore\n      corejsVersion = parseInt(require('core-js/package.json').version, 10);\n      console.log(`[OptimizePlugin] Detected core-js version ${corejsVersion}`);\n    } catch (e) {\n      console.warn(\n        `[OptimizePlugin] Unable to detect installed version of core-js. Assuming core-js@${DEFAULT_COREJS_VERSION}.`\n      );\n      corejsVersion = DEFAULT_COREJS_VERSION;\n    }\n  }\n  return corejsVersion;\n}\n\nexport function createPerformanceTimings () {\n  const timings = [];\n\n  const start = name => {\n    timings.push({ name, start: Date.now() });\n  };\n\n  const end = name => {\n    for (const entry of timings) {\n      if (entry.name === name) {\n        entry.end = Date.now();\n        entry.duration = entry.end - entry.start;\n        return;\n      }\n    }\n  };\n\n  return {\n    timings,\n    start,\n    end\n  };\n}\n","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as terser from 'terser';\nimport { toBabelMap } from './util';\n\nexport default function rollupPluginTerserSimple () {\n  return {\n    name: 'rollup-plugin-terser-simple',\n    renderChunk (source, chunk, options) {\n      const { code, map } = terser.minify(source, {\n        compress: {\n          global_defs: {\n            'typeof self': '\"object\"',\n            'globalThis': 'undefined'\n          },\n          pure_getters: true,\n          unsafe: true\n        },\n        mangle: true,\n        toplevel: true,\n        sourceMap: options.sourcemap && {\n          filename: chunk.fileName\n        }\n      });\n      return {\n        code,\n        map: toBabelMap(map)\n      };\n    }\n  };\n}\n","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport MagicString from 'magic-string';\n\nexport default function rollupPluginStripComments () {\n  return {\n    name: 'simple-minify',\n    renderChunk (source) {\n      const comments = [];\n      this.parse(source, { onComment: comments });\n      if (comments.length) {\n        const s = new MagicString(source);\n        for (const comment of comments) {\n          s.remove(comment.start, comment.end).trim();\n        }\n        return { code: s.toString(), map: null };\n      }\n      return null;\n    }\n  };\n}\n","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Worker from 'jest-worker';\n\nexport class WorkerPool {\n  constructor ({ workerPath, concurrency }) {\n    // concurrency = 0;\n    if (concurrency === false || concurrency === 0) {\n      return { enqueue: t => require(workerPath).process(t) };\n    }\n\n    const worker = new Worker(workerPath, {\n      enableWorkerThreads: false,\n      numWorkers: concurrency\n    });\n    let pending = 0;\n    let timer;\n    function check () {\n      clearTimeout(timer);\n      if (--pending === 0) {\n        timer = setTimeout(() => {\n          worker.end();\n        }, 10);\n      }\n    }\n    worker.enqueue = task => {\n      clearTimeout(timer);\n      const p = worker.process(task);\n      pending++;\n      p.then(check);\n      return p;\n    };\n    return worker;\n  }\n}\n\n/*\nimport os from 'os';\nimport Worker from 'jest-worker';\n\nexport class WorkerPool {\n  constructor ({ workerPath, concurrency }) {\n    this.concurrency = Math.max(1, Math.round(concurrency || os.cpus().length || 1));\n    this.runInBand = concurrency === 0 || concurrency === false;\n    this.workerPath = workerPath;\n    this.queue = [];\n    this.workers = [];\n    this.freeWorkers = [];\n  }\n\n  // terminateAll () {\n  //   let worker;\n  //   while ((worker = this.workers.pop())) {\n  //     worker.terminate();\n  //   }\n  // }\n\n  cleanup () {\n    clearTimeout(this.cleanupTimer);\n    const worker = this.getFreeWorker();\n    if (worker) {\n      worker.end();\n      this.cleanupTimer = setTimeout(this.cleanup.bind(this), 100);\n    }\n  }\n\n  getFreeWorker () {\n    return this.freeWorkers.pop();\n  }\n\n  addWorker () {\n    if (this.workers.length >= this.concurrency) return;\n    const worker = this.runInBand ? require(this.workerPath) : new Worker(this.workerPath, {\n      enableWorkerThreads: true,\n      numWorkers: 1\n      // maxRetries: 0\n    });\n    this.workers.push(worker);\n    return worker;\n  }\n\n  enqueue (item) {\n    return new Promise((resolve, reject) => {\n      if (this.queue.push({ item, resolve, reject }) === 1) {\n        this.process();\n      }\n    });\n  }\n\n  async process () {\n    clearTimeout(this.cleanupTimer);\n    if (!this.queue.length) {\n      this.cleanupTimer = setTimeout(this.cleanup.bind(this), 100);\n      return;\n    }\n    const worker = this.getFreeWorker() || this.addWorker();\n    if (!worker) {\n      console.log('queue full');\n      return;\n    }\n    const { item, resolve, reject } = this.queue.pop();\n    try {\n      const result = await worker.process(item);\n      resolve(result);\n    } catch (e) {\n      reject(e);\n    }\n    this.freeWorkers.unshift(worker);\n    this.process();\n  }\n}\n\n// class MockWorkerPool extends WorkerPool {\n//   constructor(options) {\n//     super({\n//       ...options,\n//       concurrency: 1\n//     });\n//   }\n//   getFreeWorker() {\n//     return require(this.workerPath);\n//   }\n// }\n*/\n","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport util from 'util';\nimport { gzip } from 'zlib';\nimport { promises as fs } from 'fs';\nimport * as webpack from 'webpack';\nimport { SourceMapSource, RawSource } from 'webpack-sources';\nimport { rollup } from 'rollup';\nimport commonjsPlugin from '@rollup/plugin-commonjs';\nimport nodeResolvePlugin from '@rollup/plugin-node-resolve';\nimport rollupPluginTerserSimple from './lib/rollup-plugin-terser-simple';\nimport rollupPluginStripComments from './lib/rollup-plugin-strip-comments';\nimport { getCorejsVersion, createPerformanceTimings } from './lib/util';\nimport { WorkerPool } from './lib/worker-pool';\n\nconst NAME = 'OptimizePlugin';\n\nconst DEFAULT_OPTIONS = {\n  /**\n   * Number of Worker Threads to use for running Babel and Terser.\n   * @default os.cpus().length // number of available CPUs\n   */\n  concurrency: undefined,\n\n  /**\n   * Produce Source Maps?\n   * @default false\n   */\n  sourceMap: false,\n\n  /**\n   * Minify bundles using Terser?\n   * @default true\n   */\n  minify: true,\n\n  /**\n   * Produce a set of bundles catering to older browsers alongside the default modern bundles.\n   * @default true\n   */\n  downlevel: true,\n\n  /**\n   * Attempt to upgrade ES5 syntax to equivalent modern syntax.\n   * @default true\n   */\n  modernize: true,\n\n  /**\n   * Show logs containing performance information and inlined polyfill.\n   */\n  verbose: true,\n\n  /**\n   * @default \"polyfills.legacy.js\"\n   */\n  polyfillsFilename: 'polyfills.legacy.js'\n};\n\nexport default class OptimizePlugin {\n  /**\n   * @param {Partial<DEFAULT_OPTIONS>?} [options]\n   */\n  constructor (options) {\n    this.options = Object.assign({}, options || {});\n    for (const i in DEFAULT_OPTIONS) {\n      if (this.options[i] == null) this.options[i] = DEFAULT_OPTIONS[i];\n    }\n\n    this.workerPool = new WorkerPool({\n      workerPath: require.resolve('./worker'),\n      concurrency: this.options.concurrency\n    });\n\n    // const { concurrency } = options;\n    // const workerPath = require.resolve('./worker');\n    // if (concurrency === 0 || concurrency === false) {\n    //   this.workerPool = new MockWorkerPool({ workerPath });\n    // }\n    // else {\n    //   this.workerPool = new WorkerPool({ workerPath, concurrency });\n    // }\n\n    this.rollupCache = {\n      modules: []\n    };\n\n    /** @type {Map<string, Promise<import('rollup').OutputChunk>>} */\n    this.polyfillsCache = new Map();\n  }\n\n  isWebpack4 () {\n    return webpack.version[0] === '4';\n  }\n\n  serializeOptions () {\n    return this._serialized || (this._serialized = JSON.stringify(this.options));\n  }\n\n  async optimize (compiler, compilation, chunks) {\n    const cwd = compiler.context;\n    const { timings, start, end } = createPerformanceTimings();\n\n    const options = {\n      corejsVersion: getCorejsVersion(),\n      minify: this.options.minify,\n      downlevel: this.options.downlevel,\n      modernize: this.options.modernize,\n      timings: this.options.verbose\n    };\n\n    const processing = new WeakMap();\n    const chunkFiles = Array.from(chunks).reduce(\n      (acc, chunk) => acc.concat(Array.from(chunk.files || [])),\n      []\n    );\n    const chunkAssets = Array.from(compilation.additionalChunkAssets || []);\n    const files = [...chunkFiles, ...chunkAssets];\n\n    start('Optimize Assets');\n    let transformed;\n    try {\n      transformed = await Promise.all(files.map(file => {\n        if (!file.endsWith('js')) return undefined;\n        const asset = compilation.assets[file];\n        let pending = processing.get(asset);\n        if (pending) return pending;\n\n        let source, map;\n        if (this.options.sourceMap && asset.sourceAndMap) {\n          ({ source, map } = asset.sourceAndMap());\n        } else {\n          source = asset.source();\n        }\n\n        const original = { file, source, map, options };\n        // @ts-ignore-next\n        const result = this.workerPool.enqueue(original);\n        pending = result.then(this.buildResultSources.bind(this, original));\n        processing.set(asset, pending);\n\n        const t = ` └ ${file}`;\n        start(t);\n        result.then(r => {\n          for (const entry of r.timings) {\n            // entry.name = '    ' + entry.name;\n            entry.depth = 2;\n            timings.push(entry);\n          }\n          end(t);\n        });\n\n        return pending;\n      }));\n    } catch (e) {\n      console.log('errored out during transformation ', e);\n      throw e;\n    }\n\n    end('Optimize Assets');\n\n    const allPolyfills = new Set();\n    const polyfillReasons = new Map();\n    transformed.filter(Boolean).forEach(({ file, modern, legacyFile, legacy, polyfills }, index) => {\n      for (const p of polyfills) {\n        allPolyfills.add(p);\n        let reasons = polyfillReasons.get(p);\n        if (!reasons) polyfillReasons.set(p, reasons = []);\n        reasons.push(legacyFile);\n      }\n\n      compilation.assets[file] = modern;\n      if (legacy) {\n        compilation.assets[legacyFile] = legacy;\n      } else {\n        // @todo is this actually necessary or desirable?\n        // should it be ReplaceSource/RawSource with an empty value?\n        delete compilation.assets[legacyFile];\n      }\n    });\n\n    const polyfillsFilename = this.options.polyfillsFilename || 'polyfills.legacy.js';\n    const polyfills = Array.from(allPolyfills);\n    let polyfillsAsset;\n\n    if (polyfills.length) {\n      start('Bundle Polyfills');\n      polyfillsAsset = await this.generatePolyfillsChunkCached(polyfills, cwd, polyfillsFilename, timings);\n      compilation.assets[polyfillsFilename] = polyfillsAsset;\n      end('Bundle Polyfills');\n    } else {\n      delete compilation.assets[polyfillsFilename];\n    }\n\n    timings.sort((t1, t2) => t1.start - t2.start);\n    if (this.options.verbose) {\n      await this.showOutputSummary(timings, polyfills, polyfillReasons, polyfillsAsset);\n    }\n  }\n\n  async generatePolyfillsChunkCached (polyfills, cwd, polyfillsFilename, timings) {\n    const polyfillsKey = polyfills.join('\\n');\n\n    let generatePolyfills = this.polyfillsCache.get(polyfillsKey);\n    if (!generatePolyfills) {\n      generatePolyfills = this.generatePolyfillsChunk(polyfills, cwd, timings);\n      this.polyfillsCache.set(polyfillsKey, generatePolyfills);\n    }\n\n    const output = await generatePolyfills;\n\n    return new SourceMapSource(\n      output.code,\n      polyfillsFilename,\n      // @ts-ignore\n      output.map\n    );\n  }\n\n  /**\n   * @todo Write cached polyfills chunk to disk\n   */\n  async generatePolyfillsChunk (polyfills, cwd, timings) {\n    const ENTRY = '\\0entry';\n\n    const entryContent = polyfills.reduce((str, p) => `${str}\\nimport \"${p}\";`, '');\n\n    const COREJS = require.resolve('core-js/package.json').replace('package.json', '');\n    const isCoreJsPath = /(?:^|\\/)core-js\\/(.+)$/;\n    const nonCoreJsPolyfills = polyfills.filter(p => !/(core-js|regenerator-runtime)/.test(p));\n\n    if (timings && nonCoreJsPolyfills.length) {\n      console.log(`  Bundling ${nonCoreJsPolyfills.length} unrecognized polyfills.`);\n    }\n\n    const polyfillsBundle = await rollup({\n      cache: this.rollupCache,\n      context: 'window',\n      perf: !!timings,\n      input: ENTRY,\n      treeshake: {\n        propertyReadSideEffects: false,\n        tryCatchDeoptimization: false,\n        unknownGlobalSideEffects: false\n      },\n      plugins: [\n        {\n          name: 'entry',\n          resolveId: id => id === ENTRY ? id : null,\n          load: id => id === ENTRY ? entryContent : null\n        },\n        {\n          name: 'core-js',\n          resolveId (id) {\n            if (/^regenerator-runtime(\\/|$)/.test(id)) {\n              return require.resolve('regenerator-runtime/runtime');\n            }\n            const m = id.match(isCoreJsPath);\n            if (m && !/\\.js$/.test(id)) {\n              return COREJS + m[1] + '.js';\n            }\n            return null;\n          },\n          load (id) {\n            const m = id.match(isCoreJsPath);\n            if (m && id.indexOf('?') === -1) {\n              return fs.readFile(COREJS + m[1], 'utf-8');\n            }\n            return null;\n          }\n        },\n        // coreJsPlugin(),\n        commonjsPlugin({\n          // ignoreGlobal: true,\n          sourceMap: false\n        }),\n        nonCoreJsPolyfills.length && nodeResolvePlugin({\n          dedupe: nonCoreJsPolyfills,\n          only: nonCoreJsPolyfills,\n          preferBuiltins: false\n        }),\n        // {\n        //   name: 'babel',\n        //   renderChunk (source) {\n        //     return require('@babel/core').transformAsync(source, {\n        //       sourceMaps: false,\n        //       minified: true,\n        //       shouldPrintComment: () => false,\n        //       presets: [\n        //         require('babel-preset-modernize')\n        //       ]\n        //     });\n        //   }\n        // },\n        this.options.minify ? (\n          rollupPluginTerserSimple()\n        ) : (\n          rollupPluginStripComments()\n        )\n      ].filter(Boolean)\n    });\n    this.setRollupCache(polyfillsBundle.cache);\n\n    const result = await polyfillsBundle.generate({\n      exports: 'none',\n      externalLiveBindings: false,\n      freeze: false,\n      compact: true,\n      format: 'iife',\n      sourcemap: false,\n      strict: false\n    });\n    const output = result.output[0];\n\n    // If verbose logging is enabled, bubble up some useful Rollup time information\n    if (timings) {\n      const times = polyfillsBundle.getTimings();\n      const add = (name, timing) => {\n        const t = times[timing];\n        if (t) timings.push({ depth: 2, name, duration: t[0] });\n      };\n      add('parse', '## parse modules');\n      add('node-resolve', '- plugin 2 (node-resolve) - resolveId (async)');\n      add('generate', '# GENERATE');\n    }\n\n    return output;\n  }\n\n  // yes I did this to fix TS inference\n  setRollupCache (cache) {\n    this.rollupCache = cache;\n  }\n\n  /** @todo move to helper file */\n  async showOutputSummary (timings, polyfills, polyfillReasons, polyfillsAsset) {\n    let totalTime = 0;\n    let timingsStr = '';\n    for (const entry of timings) {\n      totalTime += entry.duration;\n      // timingsStr += `\\n  ${('      ' + (entry.duration || '- ')).substr(-6)}ms: ${entry.name}`;\n      timingsStr += `\\n  ${new Array(entry.depth || 1).join('      ')}${String(entry.duration | 0 || '- ').padStart(6, ' ')}ms: ${entry.name}`;\n    }\n\n    polyfills = polyfills.map(polyfill => {\n      const reasons = polyfillReasons.get(polyfill);\n      return { polyfill, reasons, reasonsKey: reasons.join('\\n') };\n    });\n    polyfills.sort((p1, p2) => p1.reasonsKey.localeCompare(p2.reasonsKey));\n\n    const serializeReasons = (reasons) => {\n      if (reasons.length === 1) return reasons[0];\n      if (reasons.length > 3) {\n        return `${reasons[0]}, ${reasons[1]} and ${reasons.length - 2} others`;\n      }\n      reasons = reasons.slice();\n      const last = reasons.pop();\n      return reasons.join(', ') + ' and ' + last;\n    };\n\n    let lastReasonsKey;\n    let polyfillsStr = polyfills.reduce((str, { polyfill, reasons, reasonsKey }) => {\n      if (reasonsKey !== lastReasonsKey) {\n        str = str.replace(/├.*?$/, '└');\n        str += `\\n└ Used by ${serializeReasons(reasons)}:`;\n        lastReasonsKey = reasonsKey;\n      }\n      str += `\\n  ├ ${polyfill}`;\n      return str;\n    }, '');\n    polyfillsStr = polyfillsStr.replace(/├(.*?)$/, '└$1');\n\n    const preamble = `[${NAME}] Completed in ${totalTime | 0}ms.${timingsStr}\\n`;\n\n    if (!polyfillsAsset) {\n      console.log(preamble + 'No polyfills bundle was created.');\n      return;\n    }\n\n    const polyfillsSize = polyfillsAsset ? (await util.promisify(gzip)(polyfillsAsset.source())).byteLength : 0;\n    const polyfillsSizeStr = (polyfillsSize / 1000).toPrecision(3) + 'kB';\n\n    console.log(\n      preamble +\n      `${polyfillsAsset._name} is ${polyfillsSizeStr} and bundles ${polyfills.length} polyfills:${polyfillsStr}`\n    );\n  }\n\n  /** @todo Support other file extensions */\n  toLegacyFilename (file) {\n    let out = file.replace(/(\\.m?js)$/g, '.legacy$1');\n    if (out === file) {\n      // this will create `foo.js.legacy.js`, but it's the best we can hope for.\n      out += '.legacy.js';\n    }\n    return out;\n  }\n\n  buildResultSources (original, result) {\n    const file = original.file;\n    const modern = this.buildFile(original, result.modern);\n    let legacy, legacyFile;\n    if (result.legacy) {\n      legacyFile = this.toLegacyFilename(file);\n      legacy = this.buildFile(original, result.legacy, legacyFile);\n    }\n    return { file, legacyFile, modern, legacy, polyfills: result.polyfills };\n  }\n\n  buildFile (original, result, name) {\n    if (result.map) {\n      return new SourceMapSource(\n        result.source,\n        name || original.file,\n        result.map,\n        original.source,\n        original.map\n      );\n    }\n    // @todo use LineToLineMappedSource as the fallback?\n    return new RawSource(result.source);\n  }\n\n  // modify chunkHash (webpack 4 & 5)\n  updateChunkHash (compilation) {\n    const updateWithHash = (chunk, hash) => {\n      hash.update(NAME);\n      hash.update(this.serializeOptions());\n    };\n\n    if (this.isWebpack4()) {\n      compilation.mainTemplate.hooks.hashForChunk.tap(NAME, updateWithHash.bind(null, null));\n      compilation.chunkTemplate.hooks.hashForChunk.tap(NAME, updateWithHash.bind(null, null));\n    } else {\n      // @ts-ignore\n      webpack.javascript.JavascriptModulesPlugin.getCompilationHooks(compilation).chunkHash.tap(NAME, updateWithHash);\n    }\n  }\n\n  apply (compiler) {\n    compiler.hooks.compilation.tap(NAME, compilation => {\n      this.updateChunkHash(compilation);\n      compilation.hooks.optimizeChunkAssets.tapPromise(NAME, this.optimize.bind(this, compiler, compilation));\n    });\n  }\n}\n"],"names":["toBabelMap","map","JSON","parse","file","version","parseInt","DEFAULT_COREJS_VERSION","corejsVersion","getCorejsVersion","require","console","log","e","warn","createPerformanceTimings","timings","start","name","push","Date","now","end","entry","duration","rollupPluginTerserSimple","renderChunk","source","chunk","options","code","terser","compress","global_defs","pure_getters","unsafe","mangle","toplevel","sourceMap","sourcemap","filename","fileName","rollupPluginStripComments","comments","onComment","length","s","MagicString","comment","remove","trim","toString","WorkerPool","constructor","workerPath","concurrency","enqueue","t","process","worker","Worker","enableWorkerThreads","numWorkers","pending","timer","check","clearTimeout","setTimeout","task","p","then","NAME","DEFAULT_OPTIONS","undefined","minify","downlevel","modernize","verbose","polyfillsFilename","OptimizePlugin","Object","assign","i","workerPool","resolve","rollupCache","modules","polyfillsCache","Map","isWebpack4","webpack","serializeOptions","_serialized","stringify","optimize","compiler","compilation","chunks","cwd","context","processing","WeakMap","chunkFiles","Array","from","reduce","acc","concat","files","chunkAssets","additionalChunkAssets","transformed","Promise","all","endsWith","asset","assets","get","sourceAndMap","original","result","buildResultSources","bind","set","r","depth","allPolyfills","Set","polyfillReasons","filter","Boolean","forEach","modern","legacyFile","legacy","polyfills","index","add","reasons","polyfillsAsset","generatePolyfillsChunkCached","sort","t1","t2","showOutputSummary","polyfillsKey","join","generatePolyfills","generatePolyfillsChunk","output","SourceMapSource","ENTRY","entryContent","str","COREJS","replace","isCoreJsPath","nonCoreJsPolyfills","test","polyfillsBundle","rollup","cache","perf","input","treeshake","propertyReadSideEffects","tryCatchDeoptimization","unknownGlobalSideEffects","plugins","resolveId","id","load","m","match","indexOf","fs","readFile","commonjsPlugin","nodeResolvePlugin","dedupe","only","preferBuiltins","setRollupCache","generate","exports","externalLiveBindings","freeze","compact","format","strict","times","getTimings","timing","totalTime","timingsStr","String","padStart","polyfill","reasonsKey","p1","p2","localeCompare","serializeReasons","slice","last","pop","lastReasonsKey","polyfillsStr","preamble","polyfillsSize","util","promisify","gzip","byteLength","polyfillsSizeStr","toPrecision","_name","toLegacyFilename","out","buildFile","RawSource","updateChunkHash","updateWithHash","hash","update","mainTemplate","hooks","hashForChunk","tap","chunkTemplate","JavascriptModulesPlugin","getCompilationHooks","chunkHash","apply","optimizeChunkAssets","tapPromise"],"mappings":"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CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACzIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA,AAaA,MAAMY,IAAI,GAAG,gBAAb;AAEA,MAAMC,eAAe,GAAG;AACtB;AACF;AACA;AACA;AACEjB,EAAAA,WAAW,EAAEkB,SALS;;AAOtB;AACF;AACA;AACA;AACEnC,EAAAA,SAAS,EAAE,KAXW;;AAatB;AACF;AACA;AACA;AACEoC,EAAAA,MAAM,EAAE,IAjBc;;AAmBtB;AACF;AACA;AACA;AACEC,EAAAA,SAAS,EAAE,IAvBW;;AAyBtB;AACF;AACA;AACA;AACEC,EAAAA,SAAS,EAAE,IA7BW;;AA+BtB;AACF;AACA;AACEC,EAAAA,OAAO,EAAE,IAlCa;;AAoCtB;AACF;AACA;AACEC,EAAAA,iBAAiB,EAAE;AAvCG,CAAxB;AA0CA,AAAe,MAAMC,cAAN,CAAqB;AAClC;AACF;AACA;AACE1B,EAAAA,WAAW,CAAExB,OAAF,EAAW;AACpB,SAAKA,OAAL,GAAemD,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBpD,OAAO,IAAI,EAA7B,CAAf;;AACA,SAAK,MAAMqD,CAAX,IAAgBV,eAAhB,EAAiC;AAC/B,UAAI,KAAK3C,OAAL,CAAaqD,CAAb,KAAmB,IAAvB,EAA6B,KAAKrD,OAAL,CAAaqD,CAAb,IAAkBV,eAAe,CAAC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"}